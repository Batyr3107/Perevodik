# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã Perevodik

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

Perevodik - —ç—Ç–æ –º–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. –ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–¥–∞—á—É, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å.

## üß© –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. ChapterTranslator (–ì–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫)
**–§–∞–π–ª**: `tools/chapter_translator.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ–≤–æ–¥–∞

```python
class ChapterTranslator:
    def __init__(self):
        self.splitter = ChapterSplitter()           # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        self.memory_manager = TranslationMemoryManager()  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
        self.cached_translator = CachedDeepLTranslator()  # DeepL API
        self.character_detector = CharacterDetector()     # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
```

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã**:
- `translate_with_context()` - –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–≤–æ–¥–∞
- `_translate_segment()` - –ø–µ—Ä–µ–≤–æ–¥ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
- `_validate_structure()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å—Ç—Ä–æ–∫

### 2. ChapterSplitter (–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Ç–µ–∫—Å—Ç–∞)
**–§–∞–π–ª**: `tools/chapter_splitter.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –†–∞–∑–±–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã

```python
class ChapterSplitter:
    def split_by_lines(self, text: str) -> List[TextSegment]:
        """–ü–æ—Å—Ç—Ä–æ—á–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã"""
        
    def _detect_segment_type(self, line: str) -> str:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–µ–≥–º–µ–Ω—Ç–∞: dialogue, description, system, empty_line"""
```

**–¢–∏–ø—ã —Å–µ–≥–º–µ–Ω—Ç–æ–≤**:
- `empty_line` - –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
- `dialogue` - –¥–∏–∞–ª–æ–≥–∏ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
- `system` - —Å–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `description` - –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç

### 3. TranslationMemoryManager (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é)
**–§–∞–π–ª**: `tools/context_manager.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–≤–æ–¥—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç—å—é –∏ —Å–ø—Ä–∞–≤–æ—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

```python
class TranslationMemoryManager:
    def __init__(self):
        self.reference_data = self._load_reference_data()  # JSON –±–∞–∑–∞
        self.collection = self._init_chromadb()            # –í–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–î
    
    def get_phrase_translation(self, text: str, chapter: str) -> str:
        """–ü–æ–∏—Å–∫ –≥–æ—Ç–æ–≤–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞ —Ñ—Ä–∞–∑—ã"""
    
    def get_glossary_term(self, term: str) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞ –∏–∑ –≥–ª–æ—Å—Å–∞—Ä–∏—è"""
```

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö**:
- `translation_memory.json` - —Å–ø—Ä–∞–≤–æ—á–Ω–∞—è –±–∞–∑–∞
- `ChromaDB` - –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞

### 4. CachedDeepLTranslator (DeepL API)
**–§–∞–π–ª**: `tools/deepl_translator.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DeepL API —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

```python
class CachedDeepLTranslator:
    def translate_text(self, text: str) -> str:
        """–ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ DeepL API"""
    
    def _get_cached_translation(self, text: str) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –∏–∑ –∫—ç—à–∞"""
```

### 5. CharacterDetector (–î–µ—Ç–µ–∫—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π)
**–§–∞–π–ª**: `tools/character_detector.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –≥–æ–≤–æ—Ä–∏—Ç –∏–ª–∏ –¥—É–º–∞–µ—Ç

```python
class CharacterDetector:
    def detect_character_from_text(self, text: str) -> str:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ —Ç–µ–∫—Å—Ç—É"""
```

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```mermaid
graph TD
    A[–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç] --> B[ChapterSplitter]
    B --> C[–ü–æ—Å—Ç—Ä–æ—á–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ]
    C --> D[ChapterTranslator]
    D --> E[TranslationMemoryManager]
    E --> F{–ï—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥?}
    F -->|–î–∞| G[–í–æ–∑–≤—Ä–∞—Ç –∏–∑ –ø–∞–º—è—Ç–∏]
    F -->|–ù–µ—Ç| H[CachedDeepLTranslator]
    H --> I[DeepL API]
    I --> J[–ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞]
    J --> K[–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π]
    K --> L[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã]
    L --> M[–ì–æ—Ç–æ–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥]
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### TextSegment
```python
@dataclass
class TextSegment:
    content: str              # –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–æ–∫–∏
    segment_type: str         # –¢–∏–ø —Å–µ–≥–º–µ–Ω—Ç–∞
    line_number: int          # –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏
    character: str = None     # –ü–µ—Ä—Å–æ–Ω–∞–∂
    is_dialogue: bool = False # –î–∏–∞–ª–æ–≥
    is_system: bool = False   # –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

### TranslationResult
```python
@dataclass
class TranslationResult:
    original_text: str        # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
    translated_text: str      # –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    translator: str           # –ò—Å—Ç–æ—á–Ω–∏–∫ –ø–µ—Ä–µ–≤–æ–¥–∞
    confidence: float         # –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
    context_used: bool        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç
    memory_hit: bool          # –ü–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å
    quality_score: float      # –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
    timestamp: str            # –í—Ä–µ–º—è –ø–µ—Ä–µ–≤–æ–¥–∞
```

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### translation_memory.json
```json
{
  "phrase_translations": {
    "chapter_1": {
      "Hello world": "–ü—Ä–∏–≤–µ—Ç –º–∏—Ä"
    }
  },
  "glossary_terms": {
    "cultivation": "–∫—É–ª—å—Ç–∏–≤–∞—Ü–∏—è",
    "spiritual energy": "–¥—É—Ö–æ–≤–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è"
  },
  "translation_errors": {
    "forbidden_words": ["–∫—Ä–∞–π–Ω–µ", "—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–∞"],
    "preferred_alternatives": {
      "–∫—Ä–∞–π–Ω–µ": "–æ—á–µ–Ω—å",
      "—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–∞": "–∏–¥–µ–∞–ª—å–Ω–∞"
    }
  },
  "contextual_style_rules": {
    "Jiang Chen": {
      "examples": {
        "Damn it!": "–ë–ª–∏–Ω, –¥–∞ –ø–æ—à–ª–æ –æ–Ω–æ –≤—Å—ë!"
      }
    }
  }
}
```

### ChromaDB
- **–ö–æ–ª–ª–µ–∫—Ü–∏—è**: `translations`
- **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ**: chapter, character, quality_score
- **–í–µ–∫—Ç–æ—Ä—ã**: embeddings –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### config.py
```python
# API –∫–ª—é—á–∏
DEEPL_API_KEY = "your_api_key"

# –ö–∞—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–≤–æ–¥–∞
QUALITY_METRICS = {
    "dialogue_naturalness": 0.30,
    "term_consistency": 0.25,
    "character_voice": 0.25,
    "cultural_adaptation": 0.20
}

# –°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞
BANNED_ARCHAISMS = ["—Å–µ–π", "–¥–∞–±—ã", "–∏–±–æ", "–≤–µ—Å—å–º–∞"]
MAX_SENTENCE_LENGTH = 15
```

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - 95%+ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ –∫—ç—à–∞
2. **–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
3. **–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫** - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤
4. **–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–æ–≤
- **–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è** - —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –º–æ—â–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
- **–ú–æ–¥—É–ª—å–Ω–∞—è** - –∑–∞–º–µ–Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Å–∏—Å—Ç–µ–º—É

## üõ°Ô∏è –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- **Graceful degradation** - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ —Å–±–æ—è—Ö API
- **Retry logic** - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö
- **Fallback mechanisms** - —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø–µ—Ä–µ–≤–æ–¥–∞

### –í–∞–ª–∏–¥–∞—Ü–∏—è
- **–°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫
- **–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** - –º–Ω–æ–≥–æ–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏

## üîÆ –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

### –ù–æ–≤—ã–µ –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–∏
```python
class CustomTranslator:
    def translate_text(self, text: str) -> str:
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞
        pass
```

### –ù–æ–≤—ã–µ —Ç–∏–ø—ã —Å–µ–≥–º–µ–Ω—Ç–æ–≤
```python
def _detect_segment_type(self, line: str) -> str:
    if self._is_poetry(line):
        return 'poetry'
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã
```

### –ù–æ–≤—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞–º—è—Ç–∏
```python
class CustomMemorySource:
    def get_translation(self, text: str) -> str:
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
        pass
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–£—Ä–æ–≤–Ω–∏**: DEBUG, INFO, WARNING, ERROR
- **–§–∞–π–ª—ã**: `translation_errors.log`
- **–ú–µ—Ç—Ä–∏–∫–∏**: –≤—Ä–µ–º—è –ø–µ—Ä–µ–≤–æ–¥–∞, –∫–∞—á–µ—Å—Ç–≤–æ, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

### –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∫–∞—á–µ—Å—Ç–≤–æ, –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏** - –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∫—ç—à, –Ω–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API

---

**–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä–µ–≤–æ–¥–∞.** üéØ
